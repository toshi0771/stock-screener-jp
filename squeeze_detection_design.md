# 価格収縮（スクイーズ）検出ロジック 設計書

**作成日**: 2025年12月25日  
**目的**: ボラティリティが低下し、ブレイクアウト前の収縮状態にある銘柄を検出する

---

## 📊 チャート分析

### 提供されたチャート例

1. **日本フエルト（3512）**
   - 価格が50EMAに沿って横ばい
   - ボリンジャーバンドが非常に狭い
   - 長期間（数週間）収縮が継続

2. **イチカワ（3513）**
   - 長期間の収縮後にブレイクアウト
   - 収縮期間中は価格が50EMAに近接

3. **GMOインターネット（4784）**
   - 下降トレンド後の収縮
   - ボリンジャーバンドが収束

4. **トリニティ工業**
   - 収縮後の動き
   - 価格が50EMAに近い

---

## 🎯 検出条件の設計

### 方法1: ボリンジャーバンド幅による検出

**指標**: ボリンジャーバンド幅（BBW: Bollinger Band Width）

```
BBW = (上部バンド - 下部バンド) / 中央線 × 100
```

#### 検出条件

1. **現在のBBWが過去N日間の最小値に近い**
   - 例: 現在のBBW ≤ 過去60日間のBBW最小値 × 1.2

2. **BBWが一定期間（M日間）継続して低い**
   - 例: 過去5日間のBBWがすべて閾値以下

3. **BBWが縮小トレンド**
   - 例: BBW(今日) < BBW(5日前) < BBW(10日前)

#### パラメータ

- **期間**: 20日（ボリンジャーバンド標準設定）
- **標準偏差**: 2σ
- **比較期間**: 60日間
- **継続期間**: 5日間以上

---

### 方法2: 株価と50EMAの乖離率による検出

**指標**: 株価と50EMAの乖離率

```
乖離率 = |終値 - 50EMA| / 50EMA × 100
```

#### 検出条件

1. **現在の乖離率が小さい**
   - 例: 乖離率 ≤ 3%

2. **乖離率が一定期間（M日間）継続して小さい**
   - 例: 過去5日間の乖離率がすべて5%以下

3. **乖離率が縮小トレンド**
   - 例: 乖離率(今日) < 乖離率(5日前)

#### パラメータ

- **EMA期間**: 50日
- **乖離率閾値**: 3%以下
- **継続期間**: 5日間以上

---

### 方法3: ATR（Average True Range）による検出

**指標**: ATR（平均真の値幅）

```
ATR = N日間の真の値幅の平均
真の値幅 = max(高値 - 安値, |高値 - 前日終値|, |安値 - 前日終値|)
```

#### 検出条件

1. **現在のATRが過去N日間の最小値に近い**
   - 例: 現在のATR ≤ 過去60日間のATR最小値 × 1.2

2. **ATRが一定期間（M日間）継続して低い**
   - 例: 過去5日間のATRがすべて閾値以下

3. **ATRが縮小トレンド**
   - 例: ATR(今日) < ATR(5日前) < ATR(10日前)

#### パラメータ

- **ATR期間**: 14日
- **比較期間**: 60日間
- **継続期間**: 5日間以上

---

## 🔧 推奨実装方法

### ハイブリッドアプローチ

複数の指標を組み合わせて、より精度の高い検出を行う。

#### 検出条件（AND条件）

1. ✅ **ボリンジャーバンド幅が狭い**
   - BBW ≤ 過去60日間のBBW最小値 × 1.3
   - 過去5日間のBBWがすべて閾値以下

2. ✅ **株価が50EMAに近い**
   - 乖離率 ≤ 5%
   - 過去5日間の乖離率がすべて7%以下

3. ✅ **ボラティリティが低い**
   - ATR ≤ 過去60日間のATR最小値 × 1.3

4. ✅ **一定期間継続**
   - 上記条件が5日間以上継続

#### スコアリング方式（オプション）

各条件にスコアを付与し、合計スコアで判定する。

| 条件 | スコア |
|------|--------|
| BBWが過去60日間の最小値に近い | 30点 |
| 株価が50EMAに近い（乖離率3%以下） | 25点 |
| ATRが過去60日間の最小値に近い | 25点 |
| 5日間以上継続 | 20点 |

**合計70点以上で検出**

---

## 📝 実装仕様

### 入力データ

- **株価データ**: 終値、高値、安値（過去100日分）
- **計算済み指標**: 50EMA、ボリンジャーバンド（±2σ）

### 出力データ

- **銘柄コード**: 4桁の銘柄コード
- **銘柄名**: 会社名
- **市場**: プライム、スタンダード、グロース
- **現在のBBW**: ボリンジャーバンド幅
- **BBW最小値（60日）**: 過去60日間のBBW最小値
- **乖離率**: 株価と50EMAの乖離率
- **ATR**: 平均真の値幅
- **継続日数**: 収縮が継続している日数
- **スコア**: 総合スコア（オプション）

---

## 🧪 テストケース

### テストデータ

1. **日本フエルト（3512）**
   - 期待結果: 検出される（BBW極小、乖離率小）

2. **イチカワ（3513）**
   - 期待結果: 収縮期間中は検出される

3. **GMOインターネット（4784）**
   - 期待結果: 収縮期間中は検出される

4. **トリニティ工業**
   - 期待結果: 収縮期間中は検出される

5. **通常の銘柄**
   - 期待結果: 検出されない

---

## 📊 パラメータ調整

### 初期パラメータ

| パラメータ | 初期値 | 説明 |
|-----------|--------|------|
| **BB期間** | 20日 | ボリンジャーバンドの期間 |
| **BB標準偏差** | 2σ | ボリンジャーバンドの標準偏差 |
| **BBW閾値** | 過去60日最小値 × 1.3 | BBWの閾値 |
| **EMA期間** | 50日 | 移動平均線の期間 |
| **乖離率閾値** | 5% | 株価と50EMAの乖離率閾値 |
| **ATR期間** | 14日 | ATRの期間 |
| **ATR閾値** | 過去60日最小値 × 1.3 | ATRの閾値 |
| **継続期間** | 5日間 | 収縮が継続する最小日数 |
| **比較期間** | 60日間 | 最小値を計算する期間 |

### 調整方針

- **検出数が多すぎる場合**: 閾値を厳しくする（1.3 → 1.2）
- **検出数が少なすぎる場合**: 閾値を緩くする（1.3 → 1.5）
- **誤検出が多い場合**: 継続期間を長くする（5日 → 7日）

---

## 🚀 実装ステップ

### ステップ1: 指標計算関数の実装

- `calculate_bbw()`: ボリンジャーバンド幅を計算
- `calculate_deviation_from_ema()`: 株価と50EMAの乖離率を計算
- `calculate_atr()`: ATRを計算

### ステップ2: 検出ロジックの実装

- `detect_squeeze()`: スクイーズを検出するメイン関数
- 各条件をチェック
- スコアリング（オプション）

### ステップ3: テスト

- テストデータで動作確認
- パラメータ調整

### ステップ4: 統合

- `daily_data_collection.py`に統合
- Supabaseにデータ保存
- Webページに表示

---

## 📌 注意事項

1. **データ量**: 過去100日分の株価データが必要
2. **計算負荷**: 全銘柄に対して計算するため、処理時間がかかる可能性
3. **誤検出**: 低流動性銘柄や出来高が少ない銘柄は誤検出の可能性
4. **ブレイクアウト後**: 収縮期間が終了した銘柄は検出されない

---

## 🎯 次のステップ

1. ✅ 設計書の確認・承認
2. 🔄 指標計算関数の実装
3. 🔄 検出ロジックの実装
4. 🔄 テストとパラメータ調整
5. 🔄 統合とデプロイ
