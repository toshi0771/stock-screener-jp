# 52週高値押し目検出が0件になる問題の最終解決レポート

## 調査期間
2025年12月1日 19:00 JST ~ 2025年12月3日 23:10 JST

## 問題の概要
12月1日にEMAにタッチした銘柄が明らかに存在するにもかかわらず、Renderで実行されたCron Jobでは0件検出された。

## 根本原因

### 1. タイムゾーンの不一致（主要因）
**問題**: RenderサーバーはUTCで動作するため、`datetime.now()`がUTC時刻を返す。jQuants APIは日本時間（JST）基準でデータを管理しているため、データ取得時にタイムゾーンの不一致が発生。

**影響**: 日本時間で20:00に実行しても、UTC時刻（11:00）が使用されるため、当日のデータが取得できない。

### 2. データ取得タイミングの問題（副次的要因）
**問題**: 当日のデータを取得しようとしても、jQuants APIのデータ更新が完了していない。

**影響**: 市場終了（15:00 JST）後、jQuants APIのデータ更新（16:00-17:00頃）が完了するまで、当日のデータが取得できない。

### 3. Refresh Tokenの期限切れ（一時的要因）
**問題**: jQuants APIのRefresh Tokenは7日間有効。期限切れになると認証エラーが発生。

**影響**: 認証失敗により、全てのデータ取得が失敗。

## 実施した修正

### 修正1: タイムゾーン処理の追加
**ファイル**: `daily_data_collection.py`

**変更内容**:
```python
# 修正前
end_date = datetime.now()

# 修正後
jst = pytz.timezone('Asia/Tokyo')
now_jst = datetime.now(jst)
end_date = (now_jst - timedelta(days=1)).replace(hour=0, minute=0, second=0, microsecond=0, tzinfo=None)
```

**効果**:
- 日本時間を明示的に使用
- 前日までのデータを取得（確実にデータが確定している）

### 修正2: Cron実行時刻の変更
**設定**: Render Cron Job Schedule

**変更内容**:
- 変更前: `30 6 * * *` (06:30 UTC = 15:30 JST)
- 変更後: `0 9 * * *` (09:00 UTC = 18:00 JST)

**効果**:
- jQuants APIのデータ更新（16:00-17:00 JST頃）完了後に実行
- より確実にデータを取得可能

### 修正3: 依存関係の追加
**ファイル**: `requirements.txt`

**追加内容**:
```
pytz==2024.1
```

### 修正4: Refresh Tokenの更新
**手順**:
1. jQuants APIで新しいRefresh Tokenを発行
2. Renderの環境変数 `JQUANTS_REFRESH_TOKEN` を更新

## 検証結果

### ローカルテスト（12月1日データ）
6銘柄中5銘柄が検出された：

| 銘柄 | コード | 期待EMA | 検出結果 | 理由 |
|------|--------|---------|----------|------|
| ファナック | 6954 | 20EMA | ❌ 未検出 | EMA20が安値より低い |
| 神田通信機 | 1942 | 20EMA | ✅ 検出 | 10EMA/20EMAタッチ |
| コマツ | 6301 | 50EMA | ✅ 検出 | 10EMAタッチ |
| 中外炉工業 | 1964 | 10EMA/20EMA | ✅ 検出 | 10EMA/20EMAタッチ |
| 三菱化工機 | 6331 | 10EMA | ✅ 検出 | 10EMA/20EMAタッチ |
| 東京応化工業 | 4186 | 10EMA | ✅ 検出 | 10EMAタッチ |

**検出率**: 5/6銘柄 (83.3%)

### Render実行結果（期待値）
- **修正前**: 0銘柄/日
- **修正後**: 5銘柄前後/日（予想）

## デプロイ履歴

| 日時 | コミット | 内容 |
|------|----------|------|
| 12/1 20:10 JST | 36b621c | タイムゾーン処理追加（pytz使用） |
| 12/3 23:06 JST | dc2b713 | データ取得期間を前日までに修正 |

## 残存する既知の問題

### ファナック（6954）が検出されない理由
- **原因**: jQuants APIのEMA20計算値（4,945.63円）が12月1日の安値（4,974円）より低い
- **対応**: 現時点では対応不要。必要に応じてタッチ判定に1-2%の許容誤差を設定することを検討

### EMA計算方法の違い
- **問題**: jQuants APIとTradingViewのEMA計算方法に差異がある可能性
- **対応**: 今後、EMA計算方法を詳細に調査し、必要に応じて独自実装を検討

## 今後の改善提案

### 優先度: 高
1. **EMA計算方法の検証と調整**
   - jQuants APIとTradingViewの計算方法を比較
   - 必要に応じて独自のEMA計算ロジックを実装

2. **タッチ判定の許容誤差設定**
   - 1-2%の許容誤差を設定
   - より多くの銘柄を検出可能に

3. **データ取得確認機能**
   - データ取得状況をログに出力
   - 異常時にアラートを送信

### 優先度: 中
4. **リトライロジックの強化**
   - エクスポネンシャルバックオフを実装
   - 失敗した銘柄を記録して再試行

5. **パフォーマンス最適化**
   - 同時実行数の調整
   - データキャッシュの実装

6. **アラート機能**
   - 検出数が閾値以下の場合に通知
   - Refresh Token期限切れの事前通知

## まとめ

**問題の本質**:
1. タイムゾーンの不一致によるデータ取得失敗
2. データ取得タイミングが早すぎる
3. Refresh Tokenの期限切れ

**解決方法**:
1. 日本時間を明示的に使用（pytz）
2. 前日までのデータを取得
3. Cron実行時刻を18:00 JSTに変更
4. Refresh Tokenを定期的に更新

**期待される結果**:
- 修正後は5銘柄前後が正常に検出される
- 毎日18:00 JSTに自動実行
- データ取得の安定性向上

## 次回の自動実行
- **日時**: 12月4日 18:00 JST
- **期待検出数**: 5銘柄前後

## 参考資料
- [jQuants API仕様書](https://jpx-jquants.com/apidoc/)
- [Refresh Token取得方法](https://jpx-jquants.com/)
- [調査レポート](INVESTIGATION_REPORT.md)
- [今後の改善提案](FUTURE_IMPROVEMENTS.md)
