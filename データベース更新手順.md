# データベース更新手順 - pullback_52week → pullback_200day

## 概要

プロジェクト全体で用語を統一するため、Supabaseデータベースの既存データを更新する必要があります。

## 更新内容

### 1. detected_stocks テーブル
- `method`カラムの値を更新
- `pullback_52week` または `52week_pullback` → `200day_pullback`

### 2. screening_results テーブル
- `screening_type`カラムの値を更新
- `pullback_52week` または `52week_pullback` → `200day_pullback`

## 実行手順

### オプション1: Supabase SQL Editorで実行

1. Supabaseダッシュボードにログイン
   - URL: https://supabase.com/dashboard

2. プロジェクトを選択

3. 左メニューから「SQL Editor」を選択

4. 以下のSQLを実行:

```sql
-- detected_stocks テーブルの method カラムを更新
UPDATE detected_stocks
SET method = '200day_pullback'
WHERE method = 'pullback_52week' OR method = '52week_pullback';

-- screening_results テーブルの screening_type カラムを更新
UPDATE screening_results
SET screening_type = '200day_pullback'
WHERE screening_type = 'pullback_52week' OR screening_type = '52week_pullback';

-- 更新結果を確認
SELECT 
    method,
    COUNT(*) as count
FROM detected_stocks
WHERE method LIKE '%pullback%'
GROUP BY method;

SELECT 
    screening_type,
    COUNT(*) as count
FROM screening_results
WHERE screening_type LIKE '%pullback%'
GROUP BY screening_type;
```

5. 実行結果を確認
   - `200day_pullback`のみが表示されることを確認
   - `pullback_52week`や`52week_pullback`が0件であることを確認

### オプション2: Pythonスクリプトで実行

```python
import os
from supabase import create_client

# Supabase接続
supabase_url = os.environ.get('SUPABASE_URL')
supabase_key = os.environ.get('SUPABASE_KEY')
supabase = create_client(supabase_url, supabase_key)

# detected_stocks テーブルを更新
result1 = supabase.rpc('exec_sql', {
    'query': """
        UPDATE detected_stocks
        SET method = '200day_pullback'
        WHERE method IN ('pullback_52week', '52week_pullback')
    """
}).execute()

print(f"detected_stocks更新完了: {result1}")

# screening_results テーブルを更新
result2 = supabase.rpc('exec_sql', {
    'query': """
        UPDATE screening_results
        SET screening_type = '200day_pullback'
        WHERE screening_type IN ('pullback_52week', '52week_pullback')
    """
}).execute()

print(f"screening_results更新完了: {result2}")
```

## 注意事項

### カラム名は変更しない

`screening_results`テーブルの`pullback_52week_id`というカラム名は**変更しません**。

**理由:**
- カラム名の変更はデータベーススキーマの変更が必要
- 既存のデータとの互換性を保つため
- リスクが高い

カラム名は`pullback_52week_id`のままですが、実際には「200日新高値押し目」のデータを指しています。

## 確認方法

### 1. データベースの確認

```sql
-- detected_stocks テーブルの確認
SELECT method, COUNT(*) as count
FROM detected_stocks
GROUP BY method;

-- screening_results テーブルの確認
SELECT screening_type, COUNT(*) as count
FROM screening_results
GROUP BY screening_type;
```

### 2. アプリケーションの確認

1. https://stock-screener-jp.onrender.com/ にアクセス
2. 「200日新高値押し目」ボタンをクリック
3. スクリーニング実行
4. 結果が正しく表示されることを確認

### 3. 過去データの確認

1. 「過去データ」ボタンをクリック
2. スクリーニング実行
3. 「200日新高値押し目」セクションが正しく表示されることを確認

## トラブルシューティング

### エラー: relation "detected_stocks" does not exist

**原因**: テーブルが存在しない

**解決方法**: `supabase_schema.sql`を実行してテーブルを作成

### エラー: permission denied

**原因**: 権限不足

**解決方法**: Supabaseダッシュボードから実行するか、管理者権限で実行

### データが表示されない

**原因**: 
- データベースの更新が完了していない
- Renderのデプロイが完了していない

**解決方法**:
1. データベースの更新を確認
2. Renderのデプロイログを確認
3. ブラウザのキャッシュをクリア

## 更新後の確認チェックリスト

- [ ] detected_stocksテーブルのmethod更新完了
- [ ] screening_resultsテーブルのscreening_type更新完了
- [ ] Renderデプロイ完了
- [ ] 「200日新高値押し目」ボタンが表示される
- [ ] スクリーニング実行が正常に動作
- [ ] 過去データ表示が正常に動作
- [ ] エラーログにエラーがない

---

**作成日**: 2025-12-15  
**更新日**: 2025-12-15
