# 52週高値押し目検出が0件になる問題の調査レポート

## 調査日時
2025年12月1日 19:00-20:00 JST

## 問題の概要
12月1日にEMAにタッチした銘柄が明らかに存在するにもかかわらず、Renderで実行されたCron Jobでは0件検出された。

## 調査結果

### ローカルテスト結果（19:56 JST実行）
6銘柄中5銘柄が正常に検出された：

| 銘柄 | コード | 期待EMA | 検出結果 | 実際のタッチ |
|------|--------|---------|----------|--------------|
| ファナック | 6954 | 20EMA | ❌ 未検出 | なし（EMA20が安値より低い） |
| 神田通信機 | 1942 | 20EMA | ✅ 検出 | 10EMA/20EMA |
| コマツ | 6301 | 50EMA | ✅ 検出 | 10EMA（50EMAは未タッチ） |
| 中外炉工業 | 1964 | 10EMA/20EMA | ✅ 検出 | 10EMA/20EMA |
| 三菱化工機 | 6331 | 10EMA | ✅ 検出 | 10EMA/20EMA |
| 東京応化工業 | 4186 | 10EMA | ✅ 検出 | 10EMA |

**検出率: 5/6銘柄 (83.3%)**

### Renderでの実行結果（15:30 JST実行）
**検出数: 0/3788銘柄 (0%)**

## 根本原因

### 1. データ取得タイミングの問題（主要因）
- **Cron Job実行時刻**: 15:30 JST (06:30 UTC)
- **日本市場終了時刻**: 15:00 JST
- **jQuants APIデータ更新**: 16:00 JST以降

**結論**: Cron Jobが15:30 JSTに実行されるため、当日（12月1日）のデータがまだjQuants APIに反映されていない。そのため、前日（11月30日）までのデータでスクリーニングが実行され、12月1日にタッチした銘柄が検出されない。

### 2. EMA計算値の違い（副次的要因）
- ファナック（6954）はjQuants APIのEMA計算値とTradingViewの値に差異がある可能性
- jQuants API: EMA20 = 4,945.63円
- 12月1日安値: 4,974円
- EMA20が安値より28円低いため、タッチ判定が False

## 解決策

### 即時対応（必須）
**Cron Job実行時刻の変更**
- 現在: `30 6 * * *` (06:30 UTC = 15:30 JST)
- 変更後: `0 9 * * *` (09:00 UTC = 18:00 JST)

**理由**:
- 18:00 JSTであれば、jQuants APIのデータ更新（16:00-17:00頃）が完了している
- 当日のデータで正確なスクリーニングが可能

### 中長期対応（検討事項）

#### 1. EMA計算方法の検証
- jQuants APIとTradingViewのEMA計算方法の違いを調査
- 必要に応じて計算方法を調整

#### 2. タッチ判定の許容誤差
- 現在: `low_price <= EMA <= high_price`（厳密一致）
- 検討: 1-2%の許容誤差を設定
  ```python
  tolerance = 0.01  # 1%
  if (low_price * (1 - tolerance)) <= EMA <= (high_price * (1 + tolerance)):
  ```

#### 3. データ取得確認機能
- 当日のデータが取得できているか確認
- 取得できていない場合は警告ログを出力

## 検証方法

### 1. Cron時刻変更後の確認
1. Cron設定を `0 9 * * *` に変更
2. 手動でCron Jobをトリガー
3. ログで「52週新高値押し目: X銘柄/日」を確認
4. 期待値: 5銘柄前後が検出される

### 2. 翌日の自動実行確認
- 12月2日 18:00 JSTに自動実行
- ログで検出数を確認

## まとめ

**問題の本質**:
- スクリーニングロジック自体は正常に動作している
- データ取得タイミングが早すぎるため、当日のデータが取得できていない

**解決方法**:
- Cron Job実行時刻を18:00 JSTに変更することで解決

**期待される結果**:
- 変更後は5銘柄前後が正常に検出される
- ファナックは引き続き未検出（EMA値の差異のため）

## 参考データ

### ファナック（6954）12月1日データ
```
始値: 5,011円
高値: 5,080円
安値: 4,974円
終値: 5,038円
EMA10: 4,969.07円
EMA20: 4,945.63円
EMA50: 4,766.39円
52週高値: 5,353円
下落率: 5.88%
```

### 神田通信機（1942）12月1日データ
```
始値: 4,932円
高値: 4,959円
安値: 4,772円
終値: 4,800円
EMA10: 4,844.97円 ✅
EMA20: 4,788.88円 ✅
EMA50: 4,538.17円
52週高値: 5,076円
下落率: 5.44%
```
