# 0銘柄検出問題の調査結果（2026年1月27日）

## 📊 現状確認（1月26日実行結果）

### ✅ 成功したスクリーニング
1. **ボリンジャーバンド**: 188銘柄検出
   - 実行時間: 4時間27分6秒
   - 処理: 3783銘柄すべて完了

### ❌ 失敗したスクリーニング

2. **パーフェクトオーダー**: 0銘柄検出
   - 実行時間: 4時間28分13秒
   - 処理: 3780/3783銘柄完了（0銘柄検出）
   - 状態: 処理は正常完了したが、検出0銘柄

3. **200日新高値押し目**: タイムアウト
   - 実行時間: タイムアウト
   - 処理: 700/3783銘柄処理後にタイムアウト
   - 状態: 265銘柄検出していたが、保存前にタイムアウト

4. **スクイーズ**: 0銘柄検出（推定）
   - 過去（1月16日）: 180/3784銘柄検出（成功）
   - 現在: 詳細不明だが、0銘柄の可能性

---

## 🔍 問題の分析

### 問題1: パーフェクトオーダーの0銘柄検出

**スクリーニング条件:**
```python
# 1. パーフェクトオーダー判定
if not (latest['Close'] >= latest['EMA10'] >= 
        latest['EMA20'] >= latest['EMA50']):
    return None

# 2. 乖離率フィルター: (株価 - 50EMA) / 株価 <= 20%
divergence_pct = ((latest['Close'] - latest['EMA50']) / latest['Close']) * 100
if divergence_pct > 20:
    return None

# 3. 200SMAフィルター（オプション）
if PERFECT_ORDER_SMA200_FILTER == "above":
    if latest['Close'] < latest['SMA200']:
        return None
```

**推定原因:**
1. **データ不足**: `len(df) < 200` で除外される銘柄が多い
2. **キャッシュ問題**: 永続キャッシュから取得したデータが古い、または空
3. **日付フィルタリング問題**: `persistent_cache.get()` のフィルタリングで0行になる
4. **条件が厳しすぎる**: 乖離率20%以内の条件が厳しい

**検証方法:**
- デバッグログを追加して、どの条件で除外されているか確認
- サンプル銘柄（例: 6954）で手動テスト

---

### 問題2: スクイーズの0銘柄検出

**スクリーニング条件:**
```python
# スクイーズ条件（厳格化済み）
- 乖離率: 3.0%以内
- 継続期間: 7日以上
- BBW: 1.2倍以上
```

**推定原因:**
1. **条件が厳しすぎる**: 1月13日のコミット 0974da0 で条件を厳格化
2. **市場環境の変化**: ボラティリティが高くなり、スクイーズ条件を満たす銘柄が減少

**検証方法:**
- 条件を緩和してテスト実行
- 過去の成功例（1月16日）と現在の市場環境を比較

---

### 問題3: 200日新高値押し目のタイムアウト

**推定原因:**
1. **API呼び出しが遅い**: `API_CALL_DELAY = 2.0秒` × 3783銘柄 = 約2.1時間
2. **データ取得に時間がかかる**: 300日分のデータ取得
3. **タイムアウト設定**: GitHub Actionsのタイムアウトが12時間だが、他の処理も含めると不足

**解決策:**
- API呼び出し間隔を短縮（2.0秒 → 1.5秒）
- キャッシュヒット率を改善
- タイムアウトを延長

---

## 🛠️ 修正案

### 修正1: デバッグログの追加

パーフェクトオーダーとスクイーズに詳細なデバッグログを追加：

```python
# パーフェクトオーダー
logger.debug(f"[{code}] データ行数: {len(df)}")
logger.debug(f"[{code}] パーフェクトオーダー判定: {latest['Close'] >= latest['EMA10'] >= latest['EMA20'] >= latest['EMA50']}")
logger.debug(f"[{code}] 乖離率: {divergence_pct:.2f}%")
```

### 修正2: 統計情報の追加

各スクリーニングメソッドで統計情報を収集：

```python
self.stats = {
    "total": 0,
    "has_data": 0,
    "passed_perfect_order": 0,
    "passed_divergence": 0,
    "passed_sma200": 0,
    "final_detected": 0
}
```

### 修正3: キャッシュ問題の検証

`persistent_cache.py` の `get()` メソッドにログを追加：

```python
logger.debug(f"Cache lookup: {code}, start={start}, end={end}")
logger.debug(f"Cache file exists: {cache_file.exists()}")
if df is not None:
    logger.debug(f"Cache data rows: {len(df)}")
    logger.debug(f"Cache date range: {df['Date'].min()} ~ {df['Date'].max()}")
```

### 修正4: 条件の緩和（テスト用）

一時的に条件を緩和してテスト：

```python
# パーフェクトオーダー: 乖離率 20% → 30%
if divergence_pct > 30:  # 20 → 30
    return None

# スクイーズ: 乖離率 3.0% → 5.0%
if divergence_pct > 5.0:  # 3.0 → 5.0
    return None
```

---

## 📝 次のステップ

1. ✅ ログフォーマット修正（完了）
2. 🔄 デバッグログ追加（次）
3. 🔄 統計情報収集機能追加
4. 🔄 キャッシュ検証
5. 🔄 条件緩和テスト
6. 🔄 GitHub Actionsで再実行
7. 🔄 結果を確認してCURRENT_STATUS.mdに追記

---

## 📌 重要な発見

### ボリンジャーバンドが成功した理由

ボリンジャーバンドだけが188銘柄検出に成功した理由を分析：

1. **条件が適度**: ±3σタッチ、出来高1.5倍以上
2. **データ期間が短い**: 300日分（パーフェクトオーダーは400日分）
3. **金曜日に実行**: キャッシュが新鮮
4. **フィルタリングが緩い**: 乖離率などの厳しい条件がない

### パーフェクトオーダーが失敗した理由（推定）

1. **データ期間が長い**: 400日分（ボリンジャーバンドは300日分）
2. **条件が厳しい**: 乖離率20%以内
3. **土日実行**: キャッシュミスマッチの可能性
4. **200SMAフィルター**: 追加の除外条件

---

## 🎯 優先度

1. **最優先**: デバッグログ追加 → 原因特定
2. **高**: キャッシュ検証 → データ取得問題の解決
3. **中**: 条件緩和テスト → 検出数改善
4. **低**: タイムアウト対策 → 200日新高値押し目の安定化

---

**作成日**: 2026年1月27日  
**作成者**: Manus AI Agent
