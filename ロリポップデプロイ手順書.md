# ロリポップサーバーへのデプロイ手順書

**対象**: 株式スクリーニングアプリケーション v3.0 Final  
**作成日**: 2025年10月25日

---

## 📋 前提条件

### ロリポップサーバー要件
- **プラン**: スタンダードプラン以上推奨
- **PHP**: 不要（Pythonアプリケーション）
- **Python**: 3.8以上
- **SSH接続**: 有効化されていること
- **独自ドメイン**: 設定済み（推奨）

### 必要なファイル
- ✅ `stock_screener_final_20251025_022013.tar.gz`（本アーカイブ）

---

## 🚀 デプロイ手順

### Step 1: ロリポップサーバーにSSH接続

```bash
ssh ユーザー名@ssh.lolipop.jp
```

**接続情報の確認方法**:
1. ロリポップ管理画面にログイン
2. 「サーバーの管理・設定」→「SSH」
3. SSH接続情報を確認

---

### Step 2: アーカイブファイルのアップロード

#### 方法A: FTPでアップロード（推奨）
1. FTPクライアント（FileZilla等）でロリポップに接続
2. `stock_screener_final_20251025_022013.tar.gz` をホームディレクトリにアップロード

#### 方法B: scpコマンドでアップロード
```bash
scp stock_screener_final_20251025_022013.tar.gz ユーザー名@ssh.lolipop.jp:~/
```

---

### Step 3: アーカイブの解凍

SSH接続後、以下のコマンドを実行:

```bash
cd ~
tar -xzf stock_screener_final_20251025_022013.tar.gz
cd stock_screener_enhanced
ls -la
```

**確認すべきファイル**:
- `app.py`
- `daily_data_collection.py`
- `templates/index_new.html`
- `.env`
- `supabase_schema.sql`

---

### Step 4: Python環境の確認

```bash
# Pythonバージョン確認
python3 --version

# pipの確認
pip3 --version
```

**Python 3.8以上が必要です**。バージョンが古い場合は、ロリポップサポートに問い合わせてください。

---

### Step 5: 依存パッケージのインストール

```bash
cd ~/stock_screener_enhanced

# 必要なパッケージをインストール
pip3 install --user flask
pip3 install --user supabase
pip3 install --user requests
pip3 install --user aiohttp
pip3 install --user python-dotenv
```

**注意**: `--user` オプションを使用してユーザーディレクトリにインストールします。

---

### Step 6: 環境変数の確認

`.env` ファイルに以下の環境変数が設定されていることを確認:

```bash
cat .env
```

**必要な環境変数**:
```
SUPABASE_URL=https://asdvlrcwkbmwbosecoti.supabase.co
SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
JQUANTS_REFRESH_TOKEN=eyJjdHkiOiJKV1QiLCJlbmMiOiJBMjU2R0NNIi...
```

もし `.env` ファイルが存在しない場合は作成:

```bash
cat > .env << 'EOF'
SUPABASE_URL=https://asdvlrcwkbmwbosecoti.supabase.co
SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFzZHZscmN3a2Jtd2Jvc2Vjb3RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMjA5MzQsImV4cCI6MjA3NTU5NjkzNH0.fCULzu8evcw1MoxQybUOkdwimrmkIZ6pzVzqHuipHnY
JQUANTS_REFRESH_TOKEN=eyJjdHkiOiJKV1QiLCJlbmMiOiJBMjU2R0NNIiwiYWxnIjoiUlNBLU9BRVAifQ.PAdGfA0BsKYwho4QGcnaei3x84Q4GHz8d4ierW2cmwnhVdwPBUYYFsYmkVrFWJh_od_hQKbjqyVn5PkEqgVsMGkqtLIuMHhxcLjAO6_abdOeFhADxTGIWOpUElbAO38J0v0_1vD4L9C_Epck0WjJIOvDjX-ArP7z6cCHC-GgESxZvz2j2BUX51oE5OZ1JXsQcs-V-DwhunMXpR3d2ikdfv_IIZHmPI6EhlYtR0yGCK_6ROb3fOkIcSigbjuHY1jGhwbSfl-D3G2RavPLw-9iCINKE8jps9SrPJmzNVyrgPDUR2LwPE30DfvvFjRBVOChyD70JmbrBpw1Wsdx1DAYqA.j5o8ctcS2FvxooeT.0DRjLudgFW0ih1clV_tCb-u9f9PidujQZw1pc4DfZP31NpOQMMGDc9zdpmjpBju-cvyQTX8WuZylAOE4DPHlCgI1MG4W6UFxraTf7e5Ry63ijK7FV6JZl6lSWQ3vFyeJIaucO9gfigkK7iybv_hQT00ZJhfY8ibfUJRriQ0PClzByJKiGrC-LbQYRU-wm6jsGcsxoVF6WATcKUTZrHuLsKZ52SLzV3Mq9g6nn8bvKFOyYRMtxouqh3gIItchvYlRooxj7fYccGSD2j83F5aGh5PE0H5d0MHcAPD8gIix547DNf2H7x12XRzmV63vT2yj173HZV4RVjSPa_ehjTTclAg_mi3ShVjjwvF_1_TKCVTHYasQxexD7p8XYuR4-b731oEZQiUR5dGY9daDeCjfhDkm5wtUtH9NXe3T-f3Y4ceIqnUXTt-Nbp_8YDP0GP2EcdV5MuvmHy-NG4wiT3kFrqo1wM5tYYpb2nroHlW5VdNfKlCXnlKCh4c3CM-roDy5I15S7RVlSro31p0QrzoieMLzbJQKHT_Qnj5HAM2-nInXw7mnFKvh7IoyHErvx0kUs3kY_JlHj8gZ3oc_jftAOB6R0EKwXJNwxlK18w1ZcePD94JIvS9BKIJ4Vy83M-UDakB5OlLDM_9P-NM6FU0RmHIqIbwQbtoNoMoUVc90dsFk7M8CSZNFmGny6avbWVt7jn3XQLOGLdAiEc46ktUAXTQl1_RTlqakxezkIZ4vDXtqCpn9EFAQmHqeO7zlxEI8N_i_I8wbmS9TRK95eeBPGxE6d0Nd9i12ZifhBF1Twwo4akEX2m8zJzHh8zrjmcBnx3mjvMX_1zVlpRzPWy9En3eK53xbYEv6pldPnuRBKalJjAFM8D5XDc0aQySu-uy5ndgc2qLhmO5JmqAb29lsysUPEW_3MgVaXDpuSQKrXeM41fjm3AwXMoL41Py3YXD5apbbbPrhjJFqpOfIaYW3d3h_-bZTOf1F_4NFSjDYmQcjFsnTKB7SrVIKIRsMGiVYjJG1u8nUyd4TnsqslPjIuZ92ei2aaRNPdwSHKV09sW_dhsTa_wN2A5aA6MsqkEH33OyZUA0ORgXB2k-8wDDYKvMLPDEPSEMezc8jFfxVRmK1xZ6Bsubw9Mle3p7hDtUQvNPEe5GoN6EQ90qkCDlfzflUB8Oxt4YXgtMLVL2lafFXSUd1TaRJyRymkNGNv6Q-p4SGK2A7d3Su-ULoRtyNOVGOTTotb3m9326X00PKD0Eiy2SXc8vHgFnXtecFSfvPh1yGe_7bOKEirhg4jPqwryrgxmz0b-ax-Jn0-EiJVEQOlLfj6VqJA0yEPxaFx4Ip7GK20502dl4VaQ.AkGnkpzuc2o4BJf_4RuHeg
EOF
```

---

### Step 7: アプリケーションの起動テスト

```bash
cd ~/stock_screener_enhanced
python3 app.py
```

**正常起動の確認**:
```
 * Running on http://0.0.0.0:5000
 * Running on http://127.0.0.1:5000
```

`Ctrl+C` で一旦停止します。

---

### Step 8: バックグラウンドでアプリケーションを起動

```bash
cd ~/stock_screener_enhanced
nohup python3 app.py > app.log 2>&1 &
```

**起動確認**:
```bash
ps aux | grep app.py
tail -f app.log
```

---

### Step 9: ポート設定とリバースプロキシ

ロリポップでは、通常のポート（5000等）を直接公開できません。以下の方法で対応:

#### 方法A: .htaccessでリバースプロキシ設定

公開ディレクトリ（通常は `~/web/`）に `.htaccess` を作成:

```apache
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ http://localhost:5000/$1 [P,L]
```

#### 方法B: ロリポップのNode.js機能を利用

ロリポップの管理画面から「Node.js」機能を有効化し、Pythonアプリをプロキシ経由で公開します。

**詳細はロリポップサポートに問い合わせてください。**

---

### Step 10: 独自ドメインの設定

1. ロリポップ管理画面にログイン
2. 「独自ドメイン設定」から独自ドメインを追加
3. DNS設定でロリポップサーバーを指定
4. SSL証明書を設定（無料SSL利用可能）

---

## 🔄 日次データ収集の自動実行

### cronジョブの設定

```bash
crontab -e
```

以下を追加（東証終了後15:30に実行）:

```cron
30 15 * * 1-5 cd ~/stock_screener_enhanced && python3 daily_data_collection.py >> ~/cron.log 2>&1
```

**確認**:
```bash
crontab -l
```

---

## 🐛 トラブルシューティング

### 問題1: Pythonバージョンが古い
**解決策**: ロリポップサポートに連絡してPython 3.8以上の環境を依頼

### 問題2: パッケージインストールエラー
**解決策**: `--user` オプションを使用
```bash
pip3 install --user パッケージ名
```

### 問題3: ポート5000にアクセスできない
**解決策**: リバースプロキシ設定を確認、またはロリポップサポートに問い合わせ

### 問題4: アプリが起動しない
**解決策**: ログを確認
```bash
tail -f ~/stock_screener_enhanced/app.log
```

---

## 📞 サポート情報

### ロリポップサポート
- **電話**: 03-6805-3941
- **メール**: support@lolipop.jp
- **チャット**: 管理画面から利用可能

### よくある質問

**Q: Pythonアプリは動作しますか？**  
A: はい、SSH接続が有効なプランであれば動作します。

**Q: ポート5000を公開できますか？**  
A: 直接公開はできません。リバースプロキシまたはNode.js機能を使用してください。

**Q: 独自ドメインは必須ですか？**  
A: 必須ではありませんが、本番運用には推奨します。

---

## ✅ デプロイ完了チェックリスト

- [ ] SSH接続成功
- [ ] アーカイブファイルアップロード完了
- [ ] アーカイブ解凍完了
- [ ] Python 3.8以上確認
- [ ] 依存パッケージインストール完了
- [ ] 環境変数設定完了
- [ ] アプリケーション起動テスト成功
- [ ] バックグラウンド起動成功
- [ ] リバースプロキシ設定完了
- [ ] 独自ドメイン設定完了（任意）
- [ ] SSL証明書設定完了（任意）
- [ ] cronジョブ設定完了（任意）
- [ ] ブラウザからアクセス確認

---

## 🎯 次のステップ

1. ✅ デプロイ完了
2. **しばらく検証** ← 次はここ
3. **ユーザー登録実装**
4. **サブスク用Clerk & Stripe実装**

---

**作成日**: 2025年10月25日  
**バージョン**: v3.0 Final  
**対象アーカイブ**: stock_screener_final_20251025_022013.tar.gz

