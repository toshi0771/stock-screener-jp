# 株式スクリーニングアプリケーション - 更新履歴（最終版v3）

**作成日時**: 2025年10月25日 02:20:13  
**バージョン**: v3.0 Final

---

## 📋 本日の更新内容

### 1. パーフェクトオーダーに追加オプション実装

#### 株価と50EMAとの乖離率フィルター
- ✅ プルダウンメニュー追加
  - 全て
  - 10%未満
  - 20%未満
  - 30%未満
- ✅ 乖離率計算ロジック実装
  - 計算式: `|株価 - EMA50| / EMA50`
  - 指定された閾値未満の銘柄のみ表示
- ✅ バックエンドフィルター処理実装

**使用例**:
- 10%未満を選択 → 株価がEMA50から10%以内の銘柄のみ表示
- トレンドに沿った押し目買いポイントの発見に有効

---

### 2. 過去データ表示の改善

#### シンプルな表形式に変更
- ✅ 緑端などの装飾を削除
- ✅ コード・銘柄名をカンマ区切りで列挙
- ✅ 見やすいテーブル表示
- ✅ 不要なスタイリングを削除

**変更前**:
```html
<span class="stock-item">7203 トヨタ</span>
<span class="stock-item">6758 ソニー</span>
```

**変更後**:
```html
7203 トヨタ, 6758 ソニー, 9984 ソフトバンク
```

---

### 3. CSVダウンロード機能実装

#### ダウンロードボタン設置
- ✅ 過去データ結果欄の右上に配置
- ✅ 緑色の目立つボタンデザイン
- ✅ アイコン付き（💾 CSVダウンロード）

#### ダウンロード機能
- ✅ 10日/30日/60日単位でCSVダウンロード可能
- ✅ UTF-8エンコーディング対応
- ✅ 自動ファイル名生成
  - 形式: `screening_history_XXdays_YYYY-MM-DD.csv`
  - 例: `screening_history_30days_2025-10-25.csv`

#### CSV形式
```csv
日付,パーフェクトオーダー,ボリンジャーバンド,52週新高値押し目
2025-10-25,"7203 トヨタ, 6758 ソニー","9984 ソフトバンク","-"
2025-10-24,"6501 日立","7203 トヨタ, 6758 ソニー","9984 ソフトバンク"
```

---

## 🎯 完成した全オプション機能

### パーフェクトオーダー
1. ✅ 市場選択（全て/プライム/スタンダード/グロース）
2. ✅ 株価と200SMAの関係（全て/上/下）
3. ✅ **株価と50EMAとの乖離率（全て/10%未満/20%未満/30%未満）** ← NEW

### ボリンジャーバンド±3σ
1. ✅ 市場選択（全て/プライム/スタンダード/グロース）

### 52週新高値押し目
1. ✅ 市場選択（全て/プライム/スタンダード/グロース）
2. ✅ タッチEMA選択（全て/10EMA/20EMA/50EMA）
3. ✅ ストキャスティクス売られすぎフィルター（ON/OFF）

### 過去データ
1. ✅ 期間選択（10日/30日/60日）
2. ✅ **CSVダウンロード機能** ← NEW

---

## 🔧 技術実装詳細

### フロントエンド（index_new.html）

#### 50EMA乖離率オプション追加
```html
<div class="option-group" id="perfectOrderOptions2">
    <label class="option-label">株価と50EMAとの乖離率</label>
    <select class="option-select" id="ema50DivergenceSelect">
        <option value="all">全て</option>
        <option value="10">10%未満</option>
        <option value="20">20%未満</option>
        <option value="30">30%未満</option>
    </select>
</div>
```

#### CSVダウンロード関数
```javascript
async function downloadHistoryCSV(days) {
    // APIからデータ取得
    const response = await fetch(`/api/history?days=${days}`);
    const data = await response.json();
    
    // CSV生成
    let csv = '日付,パーフェクトオーダー,ボリンジャーバンド,52週新高値押し目\n';
    data.history.forEach(row => {
        csv += `${row.date},"${row.perfect_order_stocks}","${row.bollinger_band_stocks}","${row.pullback_stocks}"\n`;
    });
    
    // ダウンロード
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    // ... ダウンロード処理
}
```

### バックエンド（app.py）

#### 50EMA乖離率フィルター処理
```python
if method == 'perfect_order' and ema50_divergence != 'all':
    threshold = float(ema50_divergence) / 100.0  # 10% -> 0.1
    filtered_results = []
    for r in results:
        price = r.get('price')
        ema50 = r.get('ema50')
        if price and ema50 and ema50 > 0:
            divergence = abs(price - ema50) / ema50
            if divergence < threshold:
                filtered_results.append(r)
    results = filtered_results
```

---

## 📊 実装済み機能一覧（完全版）

### スクリーニング手法
1. ✅ パーフェクトオーダー（株価≥10EMA≥20EMA≥50EMA）
2. ✅ ボリンジャーバンド±3σ
3. ✅ 52週新高値押し目

### データ管理
- ✅ jQuants API連携（全3,795銘柄対応）
- ✅ Supabaseデータベース連携
- ✅ 過去データ履歴表示（10日/30日/60日）
- ✅ 日次データ収集スクリプト
- ✅ **CSVエクスポート機能** ← NEW

### フィルター機能
#### 全手法共通
- ✅ 市場選択

#### パーフェクトオーダー専用
- ✅ 200SMAフィルター
- ✅ **50EMA乖離率フィルター** ← NEW

#### 52週新高値押し目専用
- ✅ タッチEMAフィルター
- ✅ ストキャスティクスフィルター

### UI/UX
- ✅ 濃紺背景（#001f3f）
- ✅ 黄色スクリーニングボタン（#FFD700）
- ✅ 銘柄コード4桁表示
- ✅ **過去データシンプル表示** ← NEW
- ✅ レスポンシブデザイン
- ✅ **CSVダウンロードボタン** ← NEW

---

## 🚀 デプロイ準備

### 必要な環境変数
```bash
SUPABASE_URL=https://asdvlrcwkbmwbosecoti.supabase.co
SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
JQUANTS_REFRESH_TOKEN=eyJjdHkiOiJKV1QiLCJlbmMiOiJBMjU2R0NNIi...
```

### ロリポップサーバーへのデプロイ手順
1. アーカイブファイルをアップロード
2. 解凍: `tar -xzf stock_screener_final_20251025_022013.tar.gz`
3. 環境変数を設定（`.env`ファイルまたはサーバー設定）
4. 依存パッケージをインストール: `pip3 install -r requirements.txt`
5. Flaskアプリを起動: `python3 app.py`

---

## 📝 今後の実装予定

1. **ロリポップサーバーへのデプロイ** ← 次のステップ
2. **しばらく検証**
3. ~~過去データCSVダウンロード実装~~ ✅ 完了
4. **ユーザー登録実装**
5. **サブスク用Clerk & Stripe実装**

---

## 🐛 トラブルシューティング

詳細は `Flaskアプリトラブル対処法.md` を参照してください。

---

## 📦 アーカイブ情報

**ファイル名**: `stock_screener_final_20251025_022013.tar.gz`  
**サイズ**: 80KB  
**含まれるファイル**:
- app.py（Flaskアプリケーション - 50EMA乖離率フィルター実装済み）
- templates/index_new.html（UIテンプレート - CSVダウンロード機能実装済み）
- daily_data_collection.py（日次データ収集）
- .env（環境変数設定）
- supabase_schema.sql（データベーススキーマ）
- ドキュメント各種

---

## ✅ 動作確認済み

- ✅ 全スクリーニング手法が正常動作
- ✅ 全オプション機能が正常動作（50EMA乖離率含む）
- ✅ フィルター適用が正常動作
- ✅ 過去データ表示が正常動作
- ✅ CSVダウンロードが正常動作
- ✅ レスポンシブデザインが正常動作

---

## 🎉 新機能ハイライト

### 50EMA乖離率フィルター
トレンドフォロー戦略において、押し目買いのタイミングを見極めるための重要な指標です。
- 10%未満: 強いトレンド中の浅い押し目
- 20%未満: 中程度の押し目
- 30%未満: 深めの押し目

### CSVダウンロード
日々蓄積されたスクリーニングデータを外部ツール（Excel、Googleスプレッドシート等）で分析可能になりました。
- バックテスト用データとして活用
- 独自の分析・可視化
- 長期的なトレンド分析

---

**完成日**: 2025年10月25日  
**開発者**: Manus AI Agent  
**プロジェクト**: 株式スクリーニングアプリケーション v3.0 Final

