# ロリポップサーバー デプロイ手順書 v1.1

**更新日**: 2025年11月3日  
**対象**: 株式スクリーニングアプリケーション  
**サーバー**: ロリポップ（ハイスピードプラン以上推奨）

---

## 📋 前提条件

### 必要なもの
- ✅ ロリポップアカウント（ハイスピードプラン以上）
- ✅ SSH接続が有効化されている
- ✅ Python 3.8以上がインストールされている
- ✅ jQuants APIアカウント（メール: nre46682@yahoo.co.jp）
- ✅ Supabaseプロジェクト（URL: https://asdvlrcwkbmwbosecoti.supabase.co）

### デプロイパッケージ
- **ファイル名**: `stock_screener_updated_20251103_152010.tar.gz`
- **サイズ**: 72KB
- **場所**: `/home/ubuntu/stock_screener_updated_20251103_152010.tar.gz`

---

## 🚀 デプロイ手順

### ステップ1: SSH接続

```bash
# ロリポップサーバーにSSH接続
ssh <ユーザー名>@<サーバーアドレス>
```

**例**:
```bash
ssh lolipop-user@ssh-1.lolipop.jp
```

---

### ステップ2: デプロイディレクトリの作成

```bash
# ホームディレクトリに移動
cd ~

# アプリケーション用ディレクトリを作成
mkdir -p stock_screener
cd stock_screener
```

---

### ステップ3: デプロイパッケージのアップロード

**方法1: scpコマンド（ローカルPCから）**
```bash
scp stock_screener_updated_20251103_152010.tar.gz <ユーザー名>@<サーバーアドレス>:~/stock_screener/
```

**方法2: FTPクライアント（FileZillaなど）**
1. FTPクライアントでロリポップサーバーに接続
2. `~/stock_screener/`ディレクトリに移動
3. `stock_screener_updated_20251103_152010.tar.gz`をアップロード

---

### ステップ4: パッケージの展開

```bash
# stock_screenerディレクトリに移動
cd ~/stock_screener

# パッケージを展開
tar -xzf stock_screener_updated_20251103_152010.tar.gz

# 展開されたディレクトリに移動
cd stock_screener_enhanced

# ファイル構成を確認
ls -la
```

**期待される出力**:
```
app.py
daily_data_collection.py
templates/
data/
logs/
.env
requirements.txt
README.md
...
```

---

### ステップ5: 環境変数の設定

`.env`ファイルを編集して、認証情報を確認:

```bash
nano .env
```

**必要な環境変数**:
```env
# Supabase設定
SUPABASE_URL=https://asdvlrcwkbmwbosecoti.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# jQuants API設定
JQUANTS_REFRESH_TOKEN=eyJjdHkiOiJKV1QiLCJlbmMiOiJBMjU2R0NNIiwiYWxnIjoiUlNBLU9BRVAifQ...
```

保存して終了: `Ctrl+X` → `Y` → `Enter`

---

### ステップ6: 依存パッケージのインストール

```bash
# Python仮想環境を作成（推奨）
python3 -m venv venv
source venv/bin/activate

# 依存パッケージをインストール
pip install --upgrade pip
pip install -r requirements.txt
```

**requirements.txt の内容**:
```
flask
supabase
requests
aiohttp
pandas
python-dotenv
```

---

### ステップ7: Flaskアプリケーションの起動

#### 開発環境での起動（テスト用）

```bash
# Flaskアプリを起動
python3 app.py
```

**期待される出力**:
```
✅ Supabase接続成功: https://asdvlrcwkbmwbosecoti.supabase.co
============================================================
株式スクリーニングWebアプリケーション起動（シンプル実データ連携版）
============================================================
Supabase URL: https://asdvlrcwkbmwbosecoti.supabase.co
アクセスURL: http://localhost:5000
============================================================
 * Serving Flask app 'app'
 * Debug mode: on
 * Running on http://0.0.0.0:5000
```

#### 本番環境での起動（推奨）

```bash
# gunicornをインストール
pip install gunicorn

# gunicornでアプリを起動
gunicorn -w 4 -b 0.0.0.0:8080 app:app
```

**オプション説明**:
- `-w 4`: ワーカープロセス数（CPUコア数に応じて調整）
- `-b 0.0.0.0:8080`: バインドアドレスとポート
- `app:app`: モジュール名:アプリケーション名

---

### ステップ8: バックグラウンド実行（nohup）

```bash
# バックグラウンドで起動
nohup gunicorn -w 4 -b 0.0.0.0:8080 app:app > app.log 2>&1 &

# プロセスIDを確認
echo $!

# ログを確認
tail -f app.log
```

---

### ステップ9: 日次データ収集の自動実行設定

#### cronジョブの設定

```bash
# crontabを編集
crontab -e
```

**追加する設定**:
```cron
# 毎日15:30（市場クローズ後）にスクリーニング実行
30 15 * * * cd ~/stock_screener/stock_screener_enhanced && source venv/bin/activate && python3 daily_data_collection.py >> logs/cron_$(date +\%Y\%m\%d).log 2>&1
```

保存して終了: `Ctrl+X` → `Y` → `Enter`

#### cronジョブの確認

```bash
# 設定されたcronジョブを確認
crontab -l
```

---

### ステップ10: 動作確認

#### Webアプリへのアクセス

ブラウザで以下のURLにアクセス:
```
http://<サーバーアドレス>:8080
```

**確認項目**:
- ✅ ネイビーブルーの背景が表示される
- ✅ 黄色い「スクリーニング実行」ボタンが表示される
- ✅ パーフェクトオーダー、ボリンジャーバンド、52週新高値押し目のボタンが表示される

#### スクリーニング実行テスト

1. 「パーフェクトオーダー」ボタンをクリック
2. 「スクリーニング実行」ボタンをクリック
3. 結果が表示されることを確認

**期待される結果**:
- 検出銘柄数が表示される（50-150銘柄程度）
- 銘柄コード、銘柄名、株価、EMA値が表示される

#### 日次データ収集の手動テスト

```bash
cd ~/stock_screener/stock_screener_enhanced
source venv/bin/activate
python3 daily_data_collection.py
```

**期待される出力**:
```
============================================================
日次株式スクリーニングデータ収集開始（並列処理・全銘柄対応・オプション機能付き）
============================================================
✅ Supabase接続成功
銘柄リスト取得中...
✅ jQuants API認証成功
プライム市場: 1616銘柄
スタンダード市場: 1566銘柄
グロース市場: 611銘柄
合計: 3793銘柄
並列スクリーニング開始: 3793銘柄
...
パーフェクトオーダー検出: XX銘柄
ボリンジャーバンド検出: XX銘柄
52週新高値押し目検出: XX銘柄
履歴保存完了: /home/ubuntu/stock_screener/stock_screener_enhanced/data/screening_history.json
============================================================
日次データ収集完了
============================================================
```

---

## 🔧 トラブルシューティング

### 問題1: Supabase接続エラー

**エラーメッセージ**:
```
httpx.ConnectError: [Errno -2] Name or service not known
```

**原因**: DNS解決エラー、またはネットワーク接続の問題

**対処法**:
1. インターネット接続を確認
2. Supabase URLが正しいか確認
3. ファイアウォール設定を確認

---

### 問題2: jQuants API認証エラー

**エラーメッセージ**:
```
❌ jQuants API認証失敗: 401
```

**原因**: リフレッシュトークンの期限切れ

**対処法**:
1. jQuants APIにログイン（https://jpx-jquants.com/）
2. 新しいリフレッシュトークンを取得
3. `.env`ファイルの`JQUANTS_REFRESH_TOKEN`を更新

---

### 問題3: ポート競合エラー

**エラーメッセージ**:
```
Address already in use
Port 8080 is in use by another program
```

**対処法**:
```bash
# ポート8080を使用しているプロセスを確認
lsof -i:8080

# プロセスを停止
kill -9 <PID>

# または別のポートを使用
gunicorn -w 4 -b 0.0.0.0:8081 app:app
```

---

### 問題4: 依存パッケージのインストールエラー

**エラーメッセージ**:
```
ERROR: Could not find a version that satisfies the requirement ...
```

**対処法**:
```bash
# pipをアップグレード
pip install --upgrade pip

# 個別にインストール
pip install flask
pip install supabase
pip install requests
pip install aiohttp
pip install pandas
```

---

## 📊 ログファイルの確認

### アプリケーションログ
```bash
# Flaskアプリのログ
tail -f ~/stock_screener/stock_screener_enhanced/app.log

# 日次データ収集のログ
tail -f ~/stock_screener/stock_screener_enhanced/logs/daily_collection_$(date +%Y%m%d).log
```

### cronジョブのログ
```bash
# cronジョブの実行ログ
tail -f ~/stock_screener/stock_screener_enhanced/logs/cron_$(date +%Y%m%d).log
```

---

## 🔄 アプリケーションの更新

### 新しいバージョンのデプロイ

```bash
# アプリを停止
pkill -f gunicorn

# 古いファイルをバックアップ
cd ~/stock_screener
mv stock_screener_enhanced stock_screener_enhanced_backup_$(date +%Y%m%d)

# 新しいパッケージを展開
tar -xzf stock_screener_updated_YYYYMMDD_HHMMSS.tar.gz

# 環境変数をコピー
cp stock_screener_enhanced_backup_*/. env stock_screener_enhanced/.env

# アプリを再起動
cd stock_screener_enhanced
source venv/bin/activate
nohup gunicorn -w 4 -b 0.0.0.0:8080 app:app > app.log 2>&1 &
```

---

## 📞 サポート情報

### jQuants API
- **ログインURL**: https://jpx-jquants.com/
- **メール**: nre46682@yahoo.co.jp
- **パスワード**: Toushi060771

### Supabase
- **プロジェクトURL**: https://asdvlrcwkbmwbosecoti.supabase.co
- **ダッシュボード**: https://supabase.com/dashboard

---

## ✅ チェックリスト

デプロイ完了前に以下を確認:

- [ ] SSH接続が成功した
- [ ] デプロイパッケージがアップロードされた
- [ ] パッケージが正しく展開された
- [ ] `.env`ファイルが正しく設定された
- [ ] 依存パッケージがインストールされた
- [ ] Flaskアプリが起動した
- [ ] Webアプリにブラウザでアクセスできた
- [ ] スクリーニングが実行できた
- [ ] 日次データ収集が手動で実行できた
- [ ] cronジョブが設定された
- [ ] ログファイルが正しく出力されている

---

**デプロイ手順書作成**: 2025年11月3日 15:20  
**次回更新予定**: 実際のデプロイ後のフィードバック反映

