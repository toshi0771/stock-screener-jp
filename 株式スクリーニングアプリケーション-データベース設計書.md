# 株式スクリーニングアプリケーション - データベース設計書

## 概要

本文書では、株式スクリーニングアプリケーションのSupabaseデータベース設計について詳細に説明します。このデータベースは、日々のスクリーニング結果の蓄積、履歴管理、複数ユーザー対応、将来のAI推奨機能を支える基盤として設計されています。

## データベース構成

### 1. ユーザーテーブル (`users`)

**目的**: ユーザー認証とサブスクリプション管理

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| id | UUID | ユーザーの一意識別子（主キー） |
| email | VARCHAR(255) | ユーザーのメールアドレス（一意） |
| created_at | TIMESTAMP | アカウント作成日時 |
| updated_at | TIMESTAMP | 最終更新日時 |
| subscription_plan | VARCHAR(50) | サブスクリプションプラン（free/premium/pro） |
| is_active | BOOLEAN | アカウントの有効状態 |

**特徴**:
- 将来のClerk認証システムとの統合を想定
- サブスクリプション管理機能に対応
- Row Level Security (RLS) によるセキュリティ保護

### 2. スクリーニング結果テーブル (`screening_results`)

**目的**: スクリーニング実行の概要情報と条件の記録

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| id | UUID | スクリーニング結果の一意識別子 |
| user_id | UUID | 実行ユーザーの参照 |
| screening_type | VARCHAR(50) | スクリーニング種類（perfect_order/bollinger_band/52week_pullback） |
| screening_date | DATE | スクリーニング実行日 |
| market_filter | VARCHAR(20) | 市場フィルター（all/prime/standard/growth） |
| stochastic_oversold | BOOLEAN | ストキャスティクス売られすぎフィルター |
| ema_touch_filter | VARCHAR(20) | EMAタッチフィルター（all/10ema/20ema/50ema） |
| total_stocks_found | INTEGER | 検出された銘柄数 |
| execution_time_ms | INTEGER | 実行時間（ミリ秒） |

**特徴**:
- 重複実行を防ぐユニーク制約
- フィルター条件の完全な記録
- パフォーマンス監視機能

### 3. 検出銘柄詳細テーブル (`detected_stocks`)

**目的**: スクリーニングで検出された個別銘柄の詳細情報

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| id | UUID | 検出銘柄の一意識別子 |
| screening_result_id | UUID | スクリーニング結果への参照 |
| stock_code | VARCHAR(10) | 銘柄コード |
| company_name | VARCHAR(255) | 会社名 |
| market | VARCHAR(20) | 市場区分 |
| close_price | DECIMAL(10,2) | 終値 |
| volume | BIGINT | 出来高 |

**52週新高値押し目検出専用フィールド**:
| カラム名 | データ型 | 説明 |
|---------|---------|------|
| week52_high | DECIMAL(10,2) | 52週最高値 |
| week52_high_date | DATE | 52週最高値達成日 |
| touch_date | DATE | EMAタッチ日 |
| touch_ema | VARCHAR(50) | タッチしたEMA（10EMA,20EMA等） |
| pullback_percentage | DECIMAL(5,2) | 新高値からの下落率 |
| days_since_high | INTEGER | 新高値からの経過日数 |

**ボリンジャーバンド検出専用フィールド**:
| カラム名 | データ型 | 説明 |
|---------|---------|------|
| bollinger_upper | DECIMAL(10,2) | ボリンジャーバンド上限 |
| bollinger_lower | DECIMAL(10,2) | ボリンジャーバンド下限 |
| touch_direction | VARCHAR(10) | タッチ方向（upper/lower） |

**パーフェクトオーダー検出専用フィールド**:
| カラム名 | データ型 | 説明 |
|---------|---------|------|
| divergence_percentage | DECIMAL(5,2) | 乖離率 |
| sma200_position | VARCHAR(10) | 200SMAとの位置関係 |

### 4. 日次市場データテーブル (`daily_market_data`)

**目的**: AI推奨機能のための包括的な市場データ蓄積

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| id | UUID | データの一意識別子 |
| date | DATE | データ日付 |
| stock_code | VARCHAR(10) | 銘柄コード |
| open_price | DECIMAL(10,2) | 始値 |
| high_price | DECIMAL(10,2) | 高値 |
| low_price | DECIMAL(10,2) | 安値 |
| close_price | DECIMAL(10,2) | 終値 |
| volume | BIGINT | 出来高 |

**テクニカル指標フィールド**:
- EMA（10日、20日、50日）
- SMA（200日）
- ボリンジャーバンド（上限、中央、下限）
- ストキャスティクス（%K、%D）
- 52週高値・安値

### 5. AI推奨結果テーブル (`ai_recommendations`)

**目的**: 将来のAI推奨機能による投資アドバイスの記録

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| id | UUID | 推奨の一意識別子 |
| user_id | UUID | 対象ユーザー |
| stock_code | VARCHAR(10) | 推奨銘柄 |
| action | VARCHAR(20) | 推奨アクション（buy/sell/hold） |
| confidence_score | DECIMAL(3,2) | 信頼度スコア（0.00-1.00） |
| entry_price | DECIMAL(10,2) | 推奨エントリー価格 |
| target_price | DECIMAL(10,2) | 目標利確価格 |
| stop_loss_price | DECIMAL(10,2) | 損切り価格 |
| reason | TEXT | 推奨理由の説明 |

**実績追跡フィールド**:
- 実際のエントリー価格
- 実際の決済価格・日付
- 損益率

## セキュリティ設計

### Row Level Security (RLS)

**基本原則**: ユーザーは自分のデータのみアクセス可能

1. **ユーザーテーブル**: 自分のプロフィールのみ閲覧・更新可能
2. **スクリーニング結果**: 自分が実行したスクリーニングのみアクセス可能
3. **検出銘柄**: 自分のスクリーニング結果に紐づく銘柄のみ閲覧可能
4. **AI推奨**: 自分宛ての推奨のみアクセス可能
5. **日次市場データ**: 全ユーザーが読み取り可能（公開データ）

### 認証連携

- **Supabase Auth**: 基本的なユーザー認証
- **Clerk統合準備**: 将来のサブスクリプション機能向け
- **JWT トークン**: セキュアなAPI通信

## パフォーマンス最適化

### インデックス戦略

1. **日付ベースの検索**: `screening_date`、`date` フィールド
2. **ユーザーベースの検索**: `user_id` フィールド
3. **銘柄コード検索**: `stock_code` フィールド
4. **複合インデックス**: 頻繁に組み合わせて検索されるフィールド

### データ分割戦略

- **日次データ**: 日付によるパーティショニング（将来実装）
- **アーカイブ**: 古いデータの自動アーカイブ機能（将来実装）

## 拡張性設計

### 水平スケーリング

- **読み取りレプリカ**: 分析クエリの負荷分散
- **接続プーリング**: 同時接続数の最適化

### 機能拡張対応

1. **新しいスクリーニング手法**: `screening_type` の追加
2. **新しいテクニカル指標**: JSONBフィールドでの柔軟な拡張
3. **カスタムフィルター**: 動的フィルター条件の対応

## データ品質管理

### 制約とバリデーション

- **NOT NULL制約**: 必須フィールドの保証
- **UNIQUE制約**: 重複データの防止
- **CHECK制約**: データ範囲の検証
- **外部キー制約**: データ整合性の保証

### データクリーニング

- **重複除去**: 定期的な重複データチェック
- **異常値検出**: 統計的手法による異常値の特定
- **データ補完**: 欠損データの適切な処理

## 運用・監視

### バックアップ戦略

- **自動バックアップ**: Supabaseの標準機能
- **ポイントインタイム復旧**: 任意の時点への復元
- **クロスリージョンバックアップ**: 災害対策

### 監視項目

1. **パフォーマンス**: クエリ実行時間、スループット
2. **容量**: ストレージ使用量、成長率
3. **エラー**: 接続エラー、制約違反
4. **セキュリティ**: 不正アクセス試行、権限エラー

## 今後の発展計画

### フェーズ1: 基本機能（現在）
- スクリーニング結果の保存
- 履歴管理
- 基本的なユーザー管理

### フェーズ2: 分析機能
- トレンド分析
- 成功率統計
- カスタムダッシュボード

### フェーズ3: AI推奨機能
- 機械学習モデルの統合
- リアルタイム推奨
- パフォーマンス追跡

### フェーズ4: 高度な機能
- ソーシャル機能（推奨の共有）
- アラート機能
- モバイルアプリ対応

## 結論

この設計により、株式スクリーニングアプリケーションは以下の価値を提供できます：

1. **データの永続化**: 貴重なスクリーニング結果の長期保存
2. **履歴分析**: 過去の成功パターンの分析
3. **スケーラビリティ**: 多数のユーザーと大量データへの対応
4. **セキュリティ**: 企業レベルのデータ保護
5. **拡張性**: 将来の機能追加への柔軟な対応

このデータベース設計を基盤として、実用的で価値の高い株式投資支援プラットフォームを構築していきます。
